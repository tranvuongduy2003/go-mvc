name: Release & Deployment

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: "1.24"

jobs:
  # Create GitHub Release
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Get tag info
        id: tag
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Build release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          ## üöÄ Release ${{ steps.tag.outputs.version }}

          **Release Date:** ${{ steps.tag.outputs.date }}

          ### What's Changed
          ${{ steps.changelog.outputs.changelog }}

          ### üì¶ Installation

          **Docker:**
          ```bash
          docker pull ghcr.io/${{ github.repository }}-api:${{ steps.tag.outputs.version }}
          docker pull ghcr.io/${{ github.repository }}-worker:${{ steps.tag.outputs.version }}
          ```

          **Binary:**
          Download the appropriate binary for your platform from the assets below.

          ### üîß Upgrade Instructions

          1. Backup your database
          2. Run migrations: `./migrate up`
          3. Deploy new version
          4. Verify health endpoints

          ### üìù Full Changelog

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ steps.tag.outputs.version }}/CHANGELOG.md) for complete details.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            LICENSE
            README.md

  # Build binaries for multiple platforms
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: [release]

    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        component: [server, worker, migrate, cli]
        exclude:
          - goos: windows
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            EXT=".exe"
          fi

          OUTPUT="go-mvc-${{ matrix.component }}-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}${EXT}"

          case "${{ matrix.component }}" in
            server)
              CMD_PATH="cmd/main.go"
              ;;
            worker)
              CMD_PATH="cmd/worker/main.go"
              ;;
            migrate)
              CMD_PATH="cmd/migrate/main.go"
              ;;
            cli)
              CMD_PATH="cmd/cli/main.go"
              ;;
          esac

          go build -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }} -X main.buildTime=$(date -u '+%Y-%m-%d_%H:%M:%S') -X main.gitCommit=${{ github.sha }}" \
            -o "${OUTPUT}" "${CMD_PATH}"

          # Create checksum
          sha256sum "${OUTPUT}" > "${OUTPUT}.sha256"

          # Compress binary
          tar czf "${OUTPUT}.tar.gz" "${OUTPUT}"
          sha256sum "${OUTPUT}.tar.gz" > "${OUTPUT}.tar.gz.sha256"

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            go-mvc-*-${{ matrix.goos }}-${{ matrix.goarch }}*

  # Deploy to staging (simulation - no actual deployment)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [release, build-binaries]
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Simulate deployment preparation
        run: |
          echo "üöÄ Preparing deployment to staging..."
          echo "Version: ${GITHUB_REF#refs/tags/}"
          echo "Commit: ${{ github.sha }}"

      - name: Validate configuration
        run: |
          echo "‚úÖ Validating staging configuration..."
          # In real scenario: validate configs, check dependencies, etc.

      - name: Simulate database migration
        run: |
          echo "üìä Running database migrations..."
          # In real scenario: run actual migrations

      - name: Simulate service deployment
        run: |
          echo "üîÑ Deploying services..."
          echo "- API service"
          echo "- Worker service"
          # In real scenario: kubectl apply, docker deploy, etc.

      - name: Simulate health check
        run: |
          echo "üè• Running health checks..."
          sleep 5
          echo "‚úÖ All services healthy"

      - name: Deployment summary
        run: |
          echo "## Staging Deployment Complete üéâ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://staging.example.com" >> $GITHUB_STEP_SUMMARY

  # Deploy to production (simulation with approval)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    environment:
      name: production
      url: https://production.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Simulate production deployment
        run: |
          echo "üöÄ Deploying to production..."
          echo "Version: ${GITHUB_REF#refs/tags/}"

          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployment successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://api.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- Metrics: https://metrics.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- Grafana: https://grafana.example.com" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment
        run: |
          echo "üì¢ Notifying team about production deployment..."
          # In real scenario: send Slack/Discord/email notifications

  # Update documentation
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: [deploy-production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Update version in docs
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Updating documentation for version ${VERSION}"

          # Update version references in documentation
          find docs -type f -name "*.md" -exec sed -i "s/version: .*/version: ${VERSION}/g" {} +

      - name: Create documentation PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: update version to ${GITHUB_REF#refs/tags/}"
          title: "üìù Update documentation for ${GITHUB_REF#refs/tags/}"
          body: |
            Auto-generated PR to update documentation after release.

            - Updated version references
            - Updated installation instructions
          branch: docs/update-${{ github.sha }}
          delete-branch: true

  # Post-deployment verification
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production]

    steps:
      - name: Simulate smoke tests
        run: |
          echo "üß™ Running smoke tests..."
          echo "‚úÖ API health check passed"
          echo "‚úÖ Database connectivity verified"
          echo "‚úÖ Cache connectivity verified"
          echo "‚úÖ Message queue connectivity verified"

      - name: Simulate performance tests
        run: |
          echo "‚ö° Running performance tests..."
          echo "‚úÖ Response time < 100ms"
          echo "‚úÖ Throughput > 1000 req/s"

      - name: Final summary
        run: |
          echo "## üéä Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version ${GITHUB_REF#refs/tags/} has been successfully deployed to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Smoke tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Performance tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All systems operational" >> $GITHUB_STEP_SUMMARY
